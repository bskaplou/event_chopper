<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="/js/highcharts.js" type="text/javascript"></script>
<script src="http://datejs.googlecode.com/files/date.js" type="text/javascript"></script>
<form method='get' onsubmit='onsub(); return false;'>
Start date: <input type='text' name='start' id='start' value=''><br>
Stop date: <input type='text' name='stop' id='stop' value=''><br>
Group by: <select name='group' id='group'>
<option value='minute'>10 Minutes</option>
<option value='hour' selected="selected">Hour</option>
<option value='day'>Day</option>
<option value='month'>Month</option>
<option value='year'>Year</option>
</select><br>
<input type='submit'/>
</form>
<div id="container1" style="width: 100%; height: 50%"></div>
<div id="container2" style="width: 100%; height: 50%"></div>
<script>
$(document).ready(function() {
  var cur = Date.today().add(1).days();
  var last = Date.today().add(-1).days();
  $('#start').val(last.toString('yyyy-MM-dd hh:00'));
  $('#stop').val(cur.toString('yyyy-MM-dd hh:00'));
});

function onsub() {
  draw_graph($('#start').val(), $('#stop').val(), $('#group').val());
}

var srs1 = [];
var srs2 = [];
var gates_list = {
"10" : "agent.rb", 
"22" : "airberlin.rb", 
"29" : "airtickets.rb", 
"12" : "amargo.rb", 
"18" : "avia_centr.rb", 
"0" : "aviasales.rb", 
"3" : "awad.rb", 
"13" : "bilet_expert.rb", 
"17" : "biletix.rb", 
"9" : "bilet_on_line.rb", 
"16" : "bravofly.rb", 
"2" : "davs.rb", 
"23" : "etihad.rb", 
"5" : "euroavia.rb", 
"30" : "eviterra.rb", 
"4" : "geruxx.rb", 
"31" : "go_to_see.rb", 
"15" : "jetabroad.rb", 
"26" : "jetabroad.rb", 
"1" : "nabortu.rb", 
"3" : "nabortu.rb", 
"20" : "onetwotrip.rb", 
"7" : "ozon.rb", 
"11" : "pamediakopes.rb", 
"24" : "razlet.rb", 
"27" : "senturia.rb", 
"6" : "sindbad.rb", 
"14" : "spectr.rb", 
"25" : "tais.rb", 
"21" : "talarii.rb", 
"8" : "tickets_ua.rb", 
"28" : "tripsta.rb", 
"15" : "ural_airlines.rb", 
"19" : "viva_travel.rb", 
"32" : "zuji.rb"
};

var gates = {};
for(var g in gates_list) {
  gates[g]= {'click' : [], 'booking' : []};
}

function draw_graph(from, to, period) {
$.getJSON('/json?from=' + from + '&to=' + to + '&period=' + period + '&reporter=Scb2', function(data) {
  var stamps = [];
  var searches = [];
  var clicks = [];
  var bookings = [];
  for(var stamp in data) {
    stamps.push(stamp);
    clicks.push(data[stamp] && data[stamp]['total']['click'] ? data[stamp]['total']['click'] : null);
    searches.push(data[stamp] && data[stamp]['total']['search'] ? data[stamp]['total']['search'] : null);
    bookings.push(data[stamp] && data[stamp]['total']['booking'] ? data[stamp]['total']['booking'] : null);

    for(var g in gates_list) {
      gates[g]['click'].push(data[stamp] && data[stamp][g] && data[stamp][g]['click'] ? data[stamp][g]['click'] : null);
      gates[g]['booking'].push(data[stamp] && data[stamp][g] && data[stamp][g]['booking'] ? data[stamp][g]['booking'] : null);
    }
  }
  srs1.push({name : 'total_clicks' , data : clicks});
  srs2.push({name : 'total_bookings', data : bookings});
  for(var g in gates) {
    srs1.push({name : gates_list[g] , data : gates[g]['click']});
    srs2.push({name : gates_list[g], data : gates[g]['booking']});
  }
  var chart1 = new Highcharts.Chart({
         chart: {
            renderTo: 'container',
            type: 'line',
            spacingRight: 20,
            zoomType : 'x'
         },
         title: {
            text: 'clicks & searches & bookings'
         },
         yAxis: {
            title: {
               text: 'Count'
            }
         },
         xAxis: {
            categories: stamps,
            labels: {
               rotation: -90,
               y: 50
            }
         },
         series: srs1
  });
  var chart2 = new Highcharts.Chart({
         chart: {
            renderTo: 'container',
            type: 'line',
            spacingRight: 20,
            zoomType : 'x'
         },
         title: {
            text: 'clicks & searches & bookings'
         },
         yAxis: {
            title: {
               text: 'Count'
            }
         },
         xAxis: {
            categories: stamps,
            labels: {
               rotation: -90,
               y: 50
            }
         },
         series: srs2
  });

});
}</script>
</html>
